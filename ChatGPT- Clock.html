<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChronoGlass â€” Extended Suite</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-dark-a: #071029;
    --bg-dark-b: #071a2a;
    --bg-light-a: #ffffff;
    --bg-light-b: #eef7ff;

    --accent1: #00d2ff;
    --accent2: #6b46ff;
    --accent3: #ff7aa2;
    --glass-radius: 14px;
    --card-gap: 16px;
    --max-width: 1200px;
    --tile-min: 220px;
    --transition: 260ms ease;
  }

  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;font-size:16px}
  body{
    display:flex;align-items:center;justify-content:center;padding:24px;
    background:
      radial-gradient(800px 400px at 10% 25%, rgba(107,70,255,0.06), transparent),
      radial-gradient(700px 380px at 90% 80%, rgba(0,210,255,0.06), transparent),
      linear-gradient(180deg,var(--bg-dark-a),var(--bg-dark-b));
    color:#eaf4ff;
    transition: background var(--transition), color var(--transition);
  }
  html.bright body{
    background:
      radial-gradient(800px 400px at 10% 25%, rgba(107,70,255,0.02), transparent),
      radial-gradient(700px 380px at 90% 80%, rgba(0,210,255,0.03), transparent),
      linear-gradient(180deg,var(--bg-light-a),var(--bg-light-b));
    color:#082034;
  }

  .app {
    width:100%; max-width:var(--max-width);
    display:grid; gap:var(--card-gap); grid-template-columns:1fr;
  }

  .header{ display:flex;align-items:center;justify-content:space-between;gap:12px }
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;font-weight:800;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 12px 30px rgba(2,6,23,0.5)}
  .title h1{margin:0;font-size:16px} .title p{margin:0;font-size:12px;opacity:0.9}

  .controls{display:flex;gap:8px;align-items:center}
  .pill{ padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); cursor:pointer; display:inline-flex;align-items:center;gap:8px; transition:transform 160ms }
  html.bright .pill{ background:rgba(0,0,0,0.04); border:1px solid rgba(0,0,0,0.06) }
  .pill:active{ transform:translateY(1px) }

  input[type="checkbox"]{display:none}
  .switch{ width:44px;height:24px;border-radius:999px;background:rgba(255,255,255,0.06);position:relative;border:1px solid rgba(255,255,255,0.06)}
  .switch::after{ content:"";position:absolute;left:4px;top:3px;width:18px;height:18px;border-radius:50%;background:white;transition:left 220ms }
  input:checked + .switch{ background:linear-gradient(90deg,#ffd54a,#ff8a65) }
  input:checked + .switch::after{ left:22px }

  /* grid layout: left / center / right on wide screens */
  .grid { display:grid; gap:16px; grid-template-columns: 1fr; align-items:start }
  @media(min-width:980px){ .grid { grid-template-columns: 320px minmax(420px,1fr) 320px } }

  .card {
    border-radius: var(--glass-radius); padding:14px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(8px); transition: all var(--transition); box-shadow:0 12px 30px rgba(2,6,23,0.35);
  }
  html.bright .card{ background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.6)); border:1px solid rgba(0,0,0,0.06); box-shadow:0 10px 20px rgba(2,6,23,0.06) }

  h3{ margin:0 0 8px 0; font-size:14px }
  .muted{ font-size:13px; opacity:0.9; margin-bottom:8px }

  /* center clock card */
  .center-card{ display:flex;flex-direction:column;align-items:center;gap:10px; position:relative; overflow:hidden }
  .clock-large{ width:100%; padding:22px;border-radius:12px; display:flex;align-items:center;justify-content:center; gap:10px; background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); box-shadow:0 26px 44px rgba(2,6,23,0.28) }
  html.bright .clock-large{ background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(255,255,255,0.7)) }

  .clock-digits{ display:flex;gap:14px;align-items:end;flex-wrap:wrap;justify-content:center }
  .digit { font-weight:800; font-size: clamp(28px, 7.5vw, 86px); letter-spacing:-1px; padding:6px 12px; border-radius:10px; position:relative; color:transparent; -webkit-background-clip:text; background-clip:text; transition: all 220ms }
  .digit-bg{ position:absolute; left:0; right:0; top:0; bottom:0; border-radius:10px; filter:blur(12px); opacity:0.08; z-index:-1; background: linear-gradient(90deg,var(--accent1),var(--accent2)); }

  .meta{ display:flex; gap:12px; align-items:center; justify-content:space-between; width:100% }

  /* tiles grid inside columns */
  .col { display:flex; flex-direction:column; gap:12px }
  .select-row{ display:flex; gap:8px; align-items:center }

  /* reaction game */
  .reaction-dot{ width:110px; height:110px; border-radius:999px; display:flex;align-items:center;justify-content:center; font-weight:800; font-size:18px; color:white; cursor:pointer; box-shadow:0 10px 30px rgba(2,6,23,0.36) }

  /* binary clock */
  .bin-row{ display:flex; gap:6px; align-items:center }
  .bit{ width:18px; height:18px; border-radius:4px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.03) }
  .bit.on{ background:linear-gradient(90deg,var(--accent1),var(--accent2)); }

  /* progress bars */
  .progress { height:12px; width:100%; background: rgba(255,255,255,0.04); border-radius:999px; overflow:hidden }
  .progress > i{ display:block; height:100%; background: linear-gradient(90deg,var(--accent1),var(--accent3)); width:0%; transition: width 500ms ease }

  /* skins */
  .skin-btn{ padding:8px 10px; border-radius:10px; border:none; cursor:pointer }

  /* small helpers */
  .small{ font-size:12px; opacity:0.9 }
  .center{text-align:center}
  .row{ display:flex; gap:8px; align-items:center }

  /* responsive */
  @media(max-width:979px){
    .clock-large{ padding:12px }
    .digit{ font-size: clamp(22px, 14vw, 64px) }
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="ChronoGlass Extended">
    <header class="header">
      <div class="brand">
        <div class="logo">CG</div>
        <div class="title"><h1>ChronoGlass</h1><p>Clock Suite â€” Now with games & surprises</p></div>
      </div>

      <div class="controls">
        <label class="pill"><input id="hourToggle" type="checkbox"><span>24H</span></label>
        <label class="pill"><input id="themeToggle" type="checkbox"><div class="switch"></div></label>
        <button class="pill" id="helpBtn">?</button>
      </div>
    </header>

    <main class="grid" role="main" aria-live="polite">
      <!-- LEFT column -->
      <aside class="col">
        <div class="card">
          <h3>Stopwatch</h3>
          <div class="muted">Laps â€¢ Double-click Start to reset</div>
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div style="font-weight:800;font-size:18px" id="swDisplay">00:00.00</div>
            <div style="display:flex;gap:8px">
              <button class="pill" id="swLap">Lap</button>
              <button class="pill" id="swStart">Start</button>
            </div>
          </div>
          <div id="laps" style="display:flex;flex-direction:column;gap:6px;max-height:120px;overflow:auto;margin-top:8px"></div>
        </div>

        <div class="card">
          <h3>Pomodoro</h3>
          <div class="muted">Classic 25/5 workflow â€” customizable</div>
          <div class="row">
            <input id="pomWork" type="number" min="1" value="25" style="width:80px;padding:8px;border-radius:8px">
            <input id="pomBreak" type="number" min="1" value="5" style="width:80px;padding:8px;border-radius:8px">
            <button class="pill" id="pomStart">Start</button>
          </div>
          <div style="margin-top:8px" id="pomLabel">Ready</div>
        </div>

        <div class="card">
          <h3>Reaction Game</h3>
          <div class="muted">Tap the circle when it turns green â€” measures ms</div>
          <div class="center" style="margin-top:8px">
            <div id="reactionDot" class="reaction-dot" style="background: linear-gradient(90deg,var(--accent1),var(--accent2));">Wait...</div>
            <div style="margin-top:8px" id="reactionResult" class="small">No runs yet</div>
            <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
              <button class="pill" id="reactionStart">New Run</button>
              <button class="pill" id="reactionReset">Reset</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Time Facts</h3>
          <div class="muted">Random facts to amaze your friends</div>
          <div id="factText" style="font-weight:700;margin-top:8px">Loading fun fact...</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="pill" id="newFact">New Fact</button>
            <button class="pill" id="shareFact">Copy</button>
          </div>
        </div>
      </aside>

      <!-- CENTER -->
      <section class="card center-card">
        <div style="width:100%;display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div>
            <div style="font-weight:700">Main Clock</div>
            <div class="muted small">Local or Selected timezone â€” skins available</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="pill small"><input id="useSelected" type="checkbox"><span>Show Selected TZ</span></label>
            <select id="centerPreset" style="padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit"></select>
          </div>
        </div>

        <div class="clock-large" role="timer">
          <div style="position:relative;width:100%;display:flex;flex-direction:column;align-items:center;gap:8px">
            <div class="clock-digits" id="mainDigits" aria-hidden="true">
              <div style="position:relative"><div class="digit-bg"></div><div class="digit" id="dHours">00</div></div>
              <div class="digit" style="font-size:34px">:</div>
              <div style="position:relative"><div class="digit-bg"></div><div class="digit" id="dMinutes">00</div></div>
              <div class="digit" style="font-size:34px">:</div>
              <div style="position:relative"><div class="digit-bg"></div><div class="digit" id="dSeconds">00</div></div>
            </div>

            <div class="meta" style="width:100%;">
              <div id="tzInfo">Timezone: Local</div>
              <div id="dateInfo" class="small right">â€”</div>
            </div>
          </div>
        </div>

        <!-- additional center-row tiles (compact) -->
        <div style="width:100%;display:grid;grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-top:12px">
          <div class="card" style="padding:10px">
            <h3 style="font-size:13px;margin-bottom:6px">Binary Clock</h3>
            <div class="muted small">H : M : S in binary</div>
            <div style="margin-top:8px">
              <div id="binHours" class="bin-row"></div>
              <div id="binMinutes" class="bin-row" style="margin-top:6px"></div>
              <div id="binSeconds" class="bin-row" style="margin-top:6px"></div>
            </div>
          </div>

          <div class="card" style="padding:10px">
            <h3 style="font-size:13px;margin-bottom:6px">Day Progress</h3>
            <div class="muted small">How much of the day has gone</div>
            <div style="margin-top:8px" class="progress"><i id="dayProg"></i></div>
            <div style="margin-top:8px" id="dayProgLabel"></div>
          </div>

          <div class="card" style="padding:10px">
            <h3 style="font-size:13px;margin-bottom:6px">Next Hour</h3>
            <div class="muted small">Countdown to the next hour</div>
            <div style="font-weight:800;font-size:18px;margin-top:8px" id="nextHour">--:--</div>
          </div>

          <div class="card" style="padding:10px">
            <h3 style="font-size:13px;margin-bottom:6px">Skins</h3>
            <div class="muted small">Change clock gradient</div>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
              <button class="skin-btn pill" data-skin="ocean">Ocean</button>
              <button class="skin-btn pill" data-skin="violet">Violet</button>
              <button class="skin-btn pill" data-skin="sunset">Sunset</button>
              <button class="skin-btn pill" data-skin="emerald">Emerald</button>
            </div>
          </div>
        </div>

        <!-- Timezone Quiz compact -->
        <div class="card" style="width:100%;margin-top:12px">
          <h3>Timezone Quiz</h3>
          <div class="muted small">Guess the timezone from the sample time</div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
            <div style="font-weight:800" id="quizTime">--:--:--</div>
            <div style="flex:1"></div>
            <div style="display:flex;gap:8px">
              <button class="pill" id="quizNew">New</button>
              <button class="pill" id="quizReveal">Reveal</button>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px" id="quizChoices"></div>
          <div style="margin-top:8px" id="quizResult"></div>
        </div>
      </section>

      <!-- RIGHT column -->
      <aside class="col">
        <div class="card world-tile">
          <svg class="world-map" viewBox="0 0 1600 800" preserveAspectRatio="xMidYMid slice" aria-hidden="true" style="position:absolute;inset:0;opacity:0.06;pointer-events:none">
            <defs><linearGradient id="mapGrad" x1="0" x2="1"><stop offset="0" stop-color="#00d2ff"/><stop offset="1" stop-color="#6b46ff"/></linearGradient></defs>
            <g fill="url(#mapGrad)"><path d="M120 260c60-40 160-60 260-40 80 16 140 56 220 64 90 9 178-12 250-18 76-6 170 2 232 36 54 30 110 90 96 150-12 52-70 80-120 98-60 22-140 20-200 8-66-13-130-52-200-56-80-5-160 20-220 4-64-16-90-86-86-156 4-68 16-116-10-150z" opacity="0.9"/><path d="M900 450c80-40 200-30 300 0 80 24 160 72 210 136 36 46 30 100 6 150-26 52-84 86-148 92-76 7-146-12-220-34-78-24-156-56-228-100-54-34-100-76-120-136 38-10 96-26 150-8 40 14 84 34 148 0z" opacity="0.7"/></g>
          </svg>

          <h3>World Clock</h3>
          <div class="muted small">Select a timezone â€” will update main clock if toggled</div>

          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <div class="select-row">
              <select id="tzSelect" style="padding:8px;border-radius:8px"></select>
              <input id="tzCustom" type="text" placeholder="IANA e.g. Asia/Kolkata" style="padding:8px;border-radius:8px">
              <button class="pill" id="setTz">Set</button>
            </div>

            <div class="world-time">
              <div class="big" id="worldTime" style="font-weight:800">--:--:--</div>
              <div class="sub small" id="worldDate">â€”</div>
              <div class="muted-small" id="worldTzLabel">Timezone: â€”</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Stopwatch Challenge</h3>
          <div class="muted small">Try to stop the timer at exactly the target (e.g. 10s)</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <input id="challengeTarget" type="number" min="1" value="10" style="width:80px;padding:8px;border-radius:8px">
            <button class="pill" id="challengeStart">Start</button>
            <button class="pill" id="challengeStop">Stop</button>
          </div>
          <div style="margin-top:8px" id="challengeResult">â€”</div>
        </div>

        <div class="card">
          <h3>Time Capsule</h3>
          <div class="muted small">Save a short note stamped with current time</div>
          <textarea id="capsuleText" rows="3" style="width:100%;padding:8px;border-radius:8px"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="pill" id="saveCapsule">Save</button>
            <button class="pill" id="clearCapsules">Clear All</button>
          </div>
          <div id="capsuleList" style="margin-top:8px;display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto"></div>
        </div>

        <div class="card">
          <h3>Misc</h3>
          <div class="muted small">Quick actions</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button class="pill" id="copyTime">Copy Current Time</button>
            <button class="pill" id="fillFact">Put a random fact in clipboard</button>
            <button class="pill" id="resetSaved">Reset saved TZs</button>
          </div>
        </div>
      </aside>
    </main>
  </div>

<script>
/* ChronoGlass Extended JS
   - Builds on the prior version. Many interactive tiles added.
   - No external libs. All single file.
*/

// Basic helpers
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const clamp = (v,a,b) => Math.max(a, Math.min(b,v));

// Persistence keys
const KEY_THEME = 'cg_bright';
const KEY_24H = 'cg_24h';
const KEY_TZ = 'cg_selected_tz';
const KEY_SAVED = 'cg_saved_tzs';
const KEY_CAPSULES = 'cg_capsules';
const KEY_SKIN = 'cg_skin';

// Theme & hour format
const themeToggle = $('#themeToggle');
const hourToggle = $('#hourToggle');
function applyTheme(isBright){
  document.documentElement.classList.toggle('bright', !!isBright);
  themeToggle.checked = !!isBright;
  localStorage.setItem(KEY_THEME, isBright ? '1' : '0');
}
function apply24h(is24){
  hourToggle.checked = !!is24;
  localStorage.setItem(KEY_24H, is24 ? '1' : '0');
}
applyTheme(localStorage.getItem(KEY_THEME) === '1');
apply24h(localStorage.getItem(KEY_24H) === '1');
themeToggle.addEventListener('change', e => applyTheme(e.target.checked));
hourToggle.addEventListener('change', e => { apply24h(e.target.checked); });

// Time helpers using Intl
function tzTimeParts(date, tz, use24){
  try{
    const opt = { timeZone: tz, hour: '2-digit', minute:'2-digit', second:'2-digit', hour12: !use24 };
    const parts = new Intl.DateTimeFormat(undefined, opt).formatToParts(date);
    const get = type => (parts.find(p=>p.type===type)||{value:''}).value;
    const hour = get('hour').padStart(2,'0');
    const minute = get('minute').padStart(2,'0');
    const second = get('second').padStart(2,'0');
    const ampm = get('dayPeriod') || ((parseInt(hour,10)>=12)?'PM':'AM');
    const dateStr = new Intl.DateTimeFormat(undefined, { timeZone: tz, weekday:'short', month:'short', day:'numeric' }).format(date);
    return { hour, minute, second, ampm, dateStr };
  }catch(e){
    return { hour:'--', minute:'--', second:'--', ampm:'', dateStr:'Invalid TZ' };
  }
}

// ---------- Main Clock ----------
const dH = $('#dHours'), dM = $('#dMinutes'), dS = $('#dSeconds'), tzInfo = $('#tzInfo'), dateInfo = $('#dateInfo');
const useSelected = $('#useSelected'), centerPreset = $('#centerPreset');
let mainUseSelected = false;
useSelected.addEventListener('change', e => { mainUseSelected = e.target.checked; });

const PRESETS = [
  {label:'Local', tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC'},
  {label:'UTC', tz:'UTC'},
  {label:'Asia/Kolkata', tz:'Asia/Kolkata'},
  {label:'America/New_York', tz:'America/New_York'},
  {label:'Europe/London', tz:'Europe/London'},
  {label:'Asia/Tokyo', tz:'Asia/Tokyo'},
  {label:'Australia/Sydney', tz:'Australia/Sydney'},
  {label:'Europe/Paris', tz:'Europe/Paris'}
];
function populateCenterPresets(){
  centerPreset.innerHTML='';
  PRESETS.forEach(p => { const o=document.createElement('option'); o.value=p.tz; o.textContent=p.label; centerPreset.appendChild(o); });
}
populateCenterPresets();

// selected timezone
let selectedTZ = localStorage.getItem(KEY_TZ) || PRESETS[2].tz;
function renderMainClock(){
  const now = new Date();
  const use24 = hourToggle.checked;
  const tzToShow = (mainUseSelected && selectedTZ) ? selectedTZ : Intl.DateTimeFormat().resolvedOptions().timeZone;
  const parts = tzTimeParts(now, tzToShow, use24);
  dH.textContent = parts.hour;
  dM.textContent = parts.minute;
  dS.textContent = parts.second;
  tzInfo.textContent = `Timezone: ${tzToShow}`;
  dateInfo.textContent = parts.dateStr + (use24 ? ' â€¢ 24H' : ' â€¢ 12H');
}
setInterval(renderMainClock, 400);
renderMainClock();

// ---------- World tile + saved tzs ----------
const tzSelect = $('#tzSelect'); const tzCustom = $('#tzCustom'); const setTzBtn = $('#setTz');
function populateTzSelect(){
  tzSelect.innerHTML='';
  PRESETS.forEach(p => { const o = document.createElement('option'); o.value=p.tz; o.textContent = `${p.label} â€” ${p.tz}`; tzSelect.appendChild(o); });
  const saved = JSON.parse(localStorage.getItem(KEY_SAVED) || '[]');
  saved.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; tzSelect.appendChild(o); });
  tzSelect.value = selectedTZ || PRESETS[2].tz;
}
populateTzSelect();

function renderWorldTile(){
  const use = selectedTZ || PRESETS[0].tz;
  const now = new Date();
  const parts = tzTimeParts(now, use, hourToggle.checked);
  $('#worldTime').textContent = `${parts.hour}:${parts.minute}:${parts.second}`;
  $('#worldDate').textContent = parts.dateStr;
  $('#worldTzLabel').textContent = `Timezone: ${use}`;
}
setInterval(renderWorldTile, 500);
renderWorldTile();

tzSelect.addEventListener('change', e => { selectedTZ = e.target.value; localStorage.setItem(KEY_TZ, selectedTZ); renderWorldTile(); });
setTzBtn.addEventListener('click', ()=>{
  const custom = tzCustom.value.trim();
  const tzToSet = custom || tzSelect.value;
  if(!tzToSet) return alert('Enter or select a timezone.');
  // validate
  try{
    new Intl.DateTimeFormat(undefined,{timeZone:tzToSet});
    selectedTZ = tzToSet;
    localStorage.setItem(KEY_TZ, selectedTZ);
    if(custom){
      const saved = JSON.parse(localStorage.getItem(KEY_SAVED) || '[]');
      if(!saved.includes(custom)) { saved.unshift(custom); localStorage.setItem(KEY_SAVED, JSON.stringify(saved.slice(0,20))); }
      renderSavedList(); populateTzSelect();
    }
    tzCustom.value = '';
    renderWorldTile();
  }catch(e){ alert('Invalid IANA timezone'); }
});

// saved list
function renderSavedList(){
  const container = $('#savedList'); container.innerHTML='';
  const saved = JSON.parse(localStorage.getItem(KEY_SAVED) || '[]');
  saved.forEach(tz => {
    const btn = document.createElement('button'); btn.className='pill'; btn.textContent=tz;
    btn.addEventListener('click', ()=>{ selectedTZ=tz; localStorage.setItem(KEY_TZ, tz); populateTzSelect(); renderWorldTile(); renderMainClock(); });
    const del = document.createElement('button'); del.className='pill'; del.textContent='âœ•';
    del.addEventListener('click', ()=>{ const remaining = JSON.parse(localStorage.getItem(KEY_SAVED)||'[]').filter(x=>x!==tz); localStorage.setItem(KEY_SAVED, JSON.stringify(remaining)); renderSavedList(); populateTzSelect(); });
    const row = document.createElement('div'); row.style.display='flex'; row.style.gap='6px'; row.appendChild(btn); row.appendChild(del);
    container.appendChild(row);
  });
}
renderSavedList();

// ---------- Stopwatch (existing) ----------
let swRunning=false, swStart=0, swElapsed=0, lapCounter=0;
const swDisplay = $('#swDisplay'), lapsEl = $('#laps'), swStartBtn = $('#swStart'), swLapBtn = $('#swLap');
function formatStop(ms){ const cent = Math.floor((ms%1000)/10).toString().padStart(2,'0'); const s=Math.floor(ms/1000); const sec=(s%60).toString().padStart(2,'0'); const min=Math.floor(s/60).toString().padStart(2,'0'); return `${min}:${sec}.${cent}`; }
function swTick(){ const now = performance.now(); const ms = swElapsed + (swRunning ? (now - swStart) : 0); swDisplay.textContent = formatStop(ms); if(swRunning) requestAnimationFrame(swTick); }
swStartBtn.addEventListener('click', ()=>{
  if(!swRunning){ swRunning=true; swStart=performance.now(); swStartBtn.textContent='Pause'; requestAnimationFrame(swTick); } else { swRunning=false; swElapsed += performance.now()-swStart; swStartBtn.textContent='Start'; }
});
swStartBtn.addEventListener('dblclick', ()=>{ swRunning=false; swElapsed=0; swStart=0; swDisplay.textContent='00:00.00'; lapsEl.innerHTML=''; swStartBtn.textContent='Start'; lapCounter=0; });
swLapBtn.addEventListener('click', ()=>{ const now = swElapsed + (swRunning ? (performance.now()-swStart) : 0); lapCounter++; const el=document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.innerHTML=`<div>Lap ${lapCounter}</div><div>${formatStop(now)}</div>`; lapsEl.prepend(el); });

// ---------- Timer (pomodoro) ----------
let pomInterval=null, pomRunning=false, pomState='work', pomRemaining=0;
$('#pomStart').addEventListener('click', ()=>{
  if(pomRunning){ clearInterval(pomInterval); pomRunning=false; $('#pomLabel').textContent='Paused'; $('#pomStart').textContent='Start'; return; }
  const work = Math.max(1, parseInt($('#pomWork').value||25)); const br = Math.max(1, parseInt($('#pomBreak').value||5));
  pomState='work'; pomRemaining = work*60; pomRunning=true; $('#pomStart').textContent='Pause';
  $('#pomLabel').textContent = `Work â€¢ ${work}:00`;
  pomInterval = setInterval(()=>{
    pomRemaining--; if(pomRemaining<=0){ if(pomState==='work'){ pomState='break'; pomRemaining=br*60; $('#pomLabel').textContent=`Break â€¢ ${br}:00`; beep(); } else { pomState='work'; pomRemaining=work*60; $('#pomLabel').textContent=`Work â€¢ ${work}:00`; beep(); } }
    const mm = Math.floor(pomRemaining/60), ss = String(pomRemaining%60).padStart(2,'0'); $('#pomLabel').textContent = `${pomState === 'work' ? 'Work' : 'Break'} â€¢ ${mm}:${ss}`;
  },1000);
});
function beep(){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.0001; o.connect(g); g.connect(ctx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.5); o.stop(ctx.currentTime+0.6); },500);}catch(e){} }

// ---------- Reaction Game ----------
let reactTimer=null, reactStart=0, reactBest=null;
const reactionDot = $('#reactionDot'), reactionResult = $('#reactionResult'), reactionStartBtn = $('#reactionStart'), reactionResetBtn = $('#reactionReset');
function prepareReaction(){
  reactionDot.textContent='Wait...'; reactionDot.style.background='linear-gradient(90deg,var(--accent1),var(--accent2))'; clearTimeout(reactTimer);
  const wait = 800 + Math.floor(Math.random()*3000);
  reactTimer = setTimeout(()=>{ reactionDot.textContent='GO!'; reactionDot.style.background='linear-gradient(90deg,#2ecc71,#27ae60)'; reactStart = performance.now(); }, wait);
}
reactionStartBtn.addEventListener('click', ()=>{ prepareReaction(); reactionResult.textContent='...' });
reactionResetBtn.addEventListener('click', ()=>{ clearTimeout(reactTimer); reactStart=0; reactionResult.textContent='Reset'; reactionDot.textContent='Wait...'; reactionDot.style.background='linear-gradient(90deg,var(--accent1),var(--accent2))' });
reactionDot.addEventListener('click', ()=>{
  if(!reactStart){ reactionResult.textContent = 'Too soon! Click New Run.'; clearTimeout(reactTimer); return; }
  const dt = performance.now() - reactStart; reactStart = 0; reactionDot.textContent='Wait...'; reactionDot.style.background='linear-gradient(90deg,var(--accent1),var(--accent2))';
  if(reactBest === null || dt < reactBest) reactBest = dt;
  reactionResult.textContent = `Your time: ${Math.round(dt)} ms â€¢ Best: ${Math.round(reactBest)} ms`;
});

// ---------- Time Facts ----------
const FACTS = [
  "An hourglass measures time by gravity â€” it's been used for centuries.",
  "The world's most precise clocks (optical lattice clocks) would lose 1 second in billions of years.",
  "A day used to be defined by Earth's rotation; atomic clocks changed that.",
  "Leap seconds are occasionally added to keep UTC close to solar time.",
  "Greenwich Mean Time (GMT) was set at the Royal Observatory in 1884.",
  "The word 'clock' comes from the Latin 'cloca' meaning bell.",
  "Time zones were introduced by railways in the 19th century to standardize schedules.",
  "Before time zones, towns used local solar time â€” noon when the sun was highest."
];
const factText = $('#factText');
function newFact(){ factText.textContent = FACTS[Math.floor(Math.random()*FACTS.length)]; }
$('#newFact').addEventListener('click', newFact);
$('#shareFact').addEventListener('click', ()=>{ navigator.clipboard?.writeText(factText.textContent).then(()=> alert('Copied!'), ()=> alert('Copy failed')) });
newFact();

// ---------- Binary Clock ----------
function toBits(n, bits=6){ const arr = []; for(let i=bits-1;i>=0;i--){ arr.push((n>>i)&1); } return arr; }
const binH = $('#binHours'), binM = $('#binMinutes'), binS = $('#binSeconds');
function renderBinaryClock(){
  const now = new Date(); const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
  const bh=toBits(h,6), bm=toBits(m,6), bs=toBits(s,6);
  [ [binH,bh],[binM,bm],[binS,bs] ].forEach(([el,arr])=>{
    el.innerHTML=''; arr.forEach(b=>{ const d=document.createElement('div'); d.className='bit'+(b? ' on':''); el.appendChild(d); });
  });
}
setInterval(renderBinaryClock, 333); renderBinaryClock();

// ---------- Day Progress & Next Hour ----------
const dayProg = $('#dayProg'), dayProgLabel = $('#dayProgLabel'), nextHourEl = $('#nextHour');
function updateDayProgress(){
  const now = new Date();
  const start = new Date(now); start.setHours(0,0,0,0);
  const end = new Date(start); end.setDate(start.getDate()+1);
  const pct = ((now - start) / (end - start)) * 100;
  dayProg.style.width = pct + '%';
  dayProgLabel.textContent = `${pct.toFixed(2)}% of day passed`;
  // next hour
  const next = new Date(now); next.setHours(now.getHours()+1,0,0,0);
  const sec = Math.max(0, Math.round((next - now)/1000));
  const mm = String(Math.floor(sec/60)).padStart(2,'0'), ss = String(sec%60).padStart(2,'0');
  nextHourEl.textContent = `${mm}:${ss}`;
}
setInterval(updateDayProgress, 500); updateDayProgress();

// ---------- Skins ----------
const skinButtons = $$('.skin-btn');
function applySkin(name){
  let a,b,c;
  switch(name){
    case 'ocean': a='#00d2ff'; b='#3a86ff'; c='#75ffd5'; break;
    case 'violet': a='#7b2ff7'; b='#ff59a3'; c='#ffd56b'; break;
    case 'sunset': a='#ff7aa2'; b='#ffb86b'; c='#ff6b6b'; break;
    case 'emerald': a='#00d2a8'; b='#00ffb3'; c='#6bffb8'; break;
    default: a='#00d2ff'; b='#6b46ff'; c='#ff7aa2';
  }
  document.documentElement.style.setProperty('--accent1', a);
  document.documentElement.style.setProperty('--accent2', b);
  document.documentElement.style.setProperty('--accent3', c);
  localStorage.setItem(KEY_SKIN, name);
}
skinButtons.forEach(b=>b.addEventListener('click', ()=> applySkin(b.dataset.skin)));
applySkin(localStorage.getItem(KEY_SKIN) || 'ocean');

// ---------- Timezone Quiz ----------
const quizTime = $('#quizTime'), quizChoices = $('#quizChoices'), quizNew = $('#quizNew'), quizReveal = $('#quizReveal'), quizResult = $('#quizResult');
function genQuiz(){
  // pick random tz from PRESETS + saved
  const saved = JSON.parse(localStorage.getItem(KEY_SAVED) || '[]');
  const pool = PRESETS.map(p=>p.tz).concat(saved).filter(Boolean);
  if(pool.length < 3) pool.push('Asia/Kolkata','America/Los_Angeles','Europe/Berlin');
  const correct = pool[Math.floor(Math.random()*pool.length)];
  const now = new Date();
  const parts = tzTimeParts(now, correct, hourToggle.checked);
  // create choices
  const choices = new Set([correct]);
  while(choices.size < Math.min(4, pool.length)) choices.add(pool[Math.floor(Math.random()*pool.length)]);
  const arr = Array.from(choices).sort(()=>Math.random()-0.5);
  quizTime.textContent = `${parts.hour}:${parts.minute}:${parts.second}`;
  quizChoices.innerHTML = '';
  arr.forEach(tz => {
    const btn = document.createElement('button'); btn.className='pill'; btn.textContent=tz.split('/').pop().replace('_',' ') + ' â€” ' + tz;
    btn.addEventListener('click', ()=> {
      if(tz === correct){ quizResult.textContent = 'Correct ðŸŽ‰'; btn.style.border='2px solid #2ecc71'; } else { quizResult.textContent = `Wrong â€” correct: ${correct}`; btn.style.border='2px solid #ff6b6b'; }
    });
    quizChoices.appendChild(btn);
  });
  quizReveal.onclick = () => { quizResult.textContent = `Answer: ${correct}`; };
}
quizNew.addEventListener('click', genQuiz);
genQuiz();

// ---------- Stopwatch Challenge ----------
let challStart=0, challElapsed=0, challRunning=false;
$('#challengeStart').addEventListener('click', ()=>{
  challStart = performance.now(); challRunning=true; challElapsed=0; $('#challengeResult').textContent='Running... Click Stop exactly at target!';
});
$('#challengeStop').addEventListener('click', ()=>{
  if(!challRunning) return; challElapsed = (performance.now() - challStart)/1000; challRunning=false;
  const target = parseFloat($('#challengeTarget').value || 10); const diff = Math.abs(challElapsed - target);
  $('#challengeResult').textContent = `You: ${challElapsed.toFixed(3)}s â€¢ Target: ${target}s â€¢ Diff: ${diff.toFixed(3)}s`;
});

// ---------- Time Capsule ----------
function renderCapsules(){
  const c = JSON.parse(localStorage.getItem(KEY_CAPSULES) || '[]');
  const list = $('#capsuleList'); list.innerHTML='';
  c.forEach(item => {
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.gap='8px';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${item.time}</div><div class="small">${item.text}</div>`;
    const del = document.createElement('button'); del.className='pill'; del.textContent='âœ•'; del.addEventListener('click', ()=>{
      const remaining = JSON.parse(localStorage.getItem(KEY_CAPSULES)||'[]').filter(x=>x.time!==item.time || x.text!==item.text);
      localStorage.setItem(KEY_CAPSULES, JSON.stringify(remaining)); renderCapsules();
    });
    el.appendChild(left); el.appendChild(del); list.appendChild(el);
  });
}
$('#saveCapsule').addEventListener('click', ()=>{
  const txt = $('#capsuleText').value.trim(); if(!txt) return alert('Write something');
  const now = new Date(); const time = now.toLocaleString();
  const arr = JSON.parse(localStorage.getItem(KEY_CAPSULES) || '[]'); arr.unshift({time, text: txt}); localStorage.setItem(KEY_CAPSULES, JSON.stringify(arr.slice(0,50)));
  $('#capsuleText').value=''; renderCapsules();
});
$('#clearCapsules').addEventListener('click', ()=>{ localStorage.removeItem(KEY_CAPSULES); renderCapsules(); });
renderCapsules();

// ---------- Misc quick actions ----------
$('#copyTime').addEventListener('click', ()=>{
  const now = new Date(); const s = now.toLocaleString(); navigator.clipboard?.writeText(s).then(()=> alert('Time copied'), ()=> alert('Copy failed'));
});
$('#fillFact').addEventListener('click', ()=>{ navigator.clipboard?.writeText($('#factText').textContent).then(()=> alert('Copied fact!'), ()=> alert('Copy failed')) });
$('#resetSaved').addEventListener('click', ()=>{ localStorage.removeItem(KEY_SAVED); renderSavedList(); populateTzSelect(); alert('Saved TZs reset') });

// ---------- Timer start quick (center right) ----------
$('#timerStart')?.addEventListener('click', ()=>{
  // reuse simple timer behavior: setRemaining & start
  const m = Math.max(0, parseInt($('#tMin')?.value||0)), s = Math.max(0, parseInt($('#tSec')?.value||0));
  const total = m*60 + s; if(total <= 0) return alert('Set timer > 0'); let remaining = total;
  $('#timerLabel')?.textContent = `Running â€¢ ${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,'0')}`;
  const id = setInterval(()=>{ remaining--; $('#timerLabel').textContent = `Running â€¢ ${Math.floor(remaining/60)}:${String(remaining%60).padStart(2,'0')}`; if(remaining<=0){ clearInterval(id); $('#timerLabel').textContent='Done!'; beep(); } }, 1000);
});

// ---------- Quiz reveal keyboard support ----------
window.addEventListener('keydown', (e)=>{ if(e.key===' '){ e.preventDefault(); $('#swStart').click(); } if(e.key.toLowerCase()==='t'){ $('#timerStart').click(); } });

// ---------- Initial populate & intervals ----------
populateTzSelect(); renderSavedList(); renderWorldTile(); renderMainClock(); newFact();

// small intervals to keep dynamic tiles fresh
setInterval(()=>{ renderWorldTile(); renderMainClock(); renderBinaryClock(); updateDayProgress(); }, 500);

// Onload skin / theme
if(localStorage.getItem(KEY_SKIN)) applySkin(localStorage.getItem(KEY_SKIN));
if(localStorage.getItem(KEY_TZ)) { selectedTZ = localStorage.getItem(KEY_TZ); populateTzSelect(); renderWorldTile(); }
</script>
</body>
</html>